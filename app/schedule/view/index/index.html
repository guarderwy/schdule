<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§åŒ»ç–—æ’ç­ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
        :root {
            --h-blue: #409eff;
            --h-green: #67c23a;
            --h-red: #f56c6c;
            --h-orange: #e6a23c;
            --h-gray: #909399;
        }

        body {
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            font-family: "PingFang SC", sans-serif;
        }

        .app-container {
            max-width: 1500px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .stats-group {
            display: flex;
            gap: 15px;
        }

        .stat-item {
            border-left: 3px solid #eee;
            padding-left: 15px;
        }

        .stat-item b {
            font-size: 20px;
            color: var(--h-blue);
        }

        .stat-item span {
            font-size: 12px;
            color: #999;
            display: block;
        }

        /* çº¯æ–‡å­—ç­æ¬¡é¢œè‰² */
        .txt-p {
            color: var(--h-red);
            font-weight: 800;
        }

        .txt-n {
            color: var(--h-blue);
            font-weight: 800;
        }

        .txt-off {
            color: var(--h-gray);
            font-weight: normal;
        }

        .txt-work {
            color: var(--h-green);
            font-weight: 600;
        }

        .txt-empty {
            color: #dcdfe6;
        }

        .section-title {
            font-size: 15px;
            font-weight: bold;
            color: #333;
            margin: 20px 0 10px;
            display: flex;
            align-items: center;
        }

        .section-title i {
            color: var(--h-blue);
            margin-right: 6px;
        }

        .action-bar {
            padding: 12px;
            background: #fcfdfe;
            border: 1px dashed #dcdfe6;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .night-row {
            background-color: #fdfaf5 !important;
        }

        .el-table .cell {
            padding: 4px !important;
        }

        .shift-select .el-input__inner {
            border: none !important;
            box-shadow: none !important;
            text-align: center;
            background: transparent !important;
            font-weight: bold;
            font-size: 13px;
        }

        .el-tabs--border-card {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ebeef5;
        }
    </style>
</head>

<body>
    <div id="app" class="app-container">
        <div class="header-bar">
            <div>
                <h1 style="margin:0; font-size: 22px; color: #303133;">ğŸ¥ æ™ºæ…§åŒ»ç–—æ’ç­ç³»ç»Ÿ</h1>
                <p style="margin:4px 0 0; font-size: 13px; color: #909399;">æ¨ç®—èµ·ç‚¹ï¼š<b style="color:var(--h-blue)">{{
                        nextWeekRange.start }}</b></p>
            </div>
            <div class="stats-group">
                <div class="stat-item"><b>{{ staffList.length }}</b><span>æ€»äººæ•°</span></div>
                <div class="stat-item"><b>{{ requestList.length }}</b><span>å¾…åŠéœ€æ±‚</span></div>
                <div class="stat-item"><b style="color:var(--h-green)">{{ staffList.filter(s => s.is_night_group).length
                        }}</b><span>å¤œç­ç»„</span></div>
            </div>
        </div>

        <el-tabs v-model="activeTab" type="border-card">
            <el-tab-pane name="schedule">
                <template #label><el-icon>
                        <Calendar />
                    </el-icon> æ’ç­ç®¡ç†</template>
                <div class="section-title"><el-icon>
                        <InfoFilled />
                    </el-icon>æœ¬å‘¨å›é¡¾</div>
                <el-table :data="staffList" border size="small" :row-class-name="tableRowClassName">
                    <el-table-column prop="name" label="å§“å" width="90" fixed align="center"></el-table-column>
                    <el-table-column v-for="day in thisWeekDays" :key="day.date" :label="day.label" align="center">
                        <template #default="scope">
                            <span :class="getShiftTextClass(thisWeekData[scope.row.id]?.[day.date])">
                                {{ thisWeekData[scope.row.id]?.[day.date] || '-' }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column label="ç”³è¯·" width="60" fixed="right" align="center">
                        <template #default="scope">
                            <el-button type="primary" icon="EditPen" link @click="openRequest(scope.row)"></el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <div class="action-bar">
                    <el-button type="primary" icon="MagicStick" @click="handleGenerate">ä¸€é”®ç”Ÿæˆä¸‹å‘¨</el-button>
                    <el-button type="info" icon="CopyDocument" @click="copyLastWeek" plain>åŒæ­¥æœ¬å‘¨è§„å¾‹</el-button>
                    <div style="flex:1"></div>
                    <el-button type="success" icon="Checked" @click="validateAndSave" size="large">ä¿å­˜ä¸‹å‘¨æ’ç­</el-button>
                </div>

                <div class="section-title"><el-icon>
                        <Edit />
                    </el-icon>ä¸‹å‘¨ç¼–è¾‘</div>
                <el-table :data="staffList" border size="small" :row-class-name="tableRowClassName">
                    <el-table-column prop="name" label="å§“å" width="90" fixed align="center"></el-table-column>
                    <el-table-column v-for="day in nextWeekDays" :key="day.date" :label="day.label" align="center">
                        <template #default="scope">
                            <el-select v-model="nextWeekData[scope.row.id][day.date]" size="small" class="shift-select"
                                filterable allow-create>
                                <el-option v-for="s in shiftOptions" :key="s" :label="s" :value="s">
                                    <span :class="getShiftTextClass(s)">{{ s }}</span>
                                </el-option>
                            </el-select>
                        </template>
                    </el-table-column>
                </el-table>
            </el-tab-pane>

            <el-tab-pane name="requests">
                <template #label>
                    <el-badge :value="requestList.length" :hidden="requestList.length === 0" class="item">
                        <el-icon>
                            <ChatDotRound />
                        </el-icon> éœ€æ±‚ç”³è¯·
                    </el-badge>
                </template>
                <div class="section-title">æ‰€æœ‰æ’ç­/ä¼‘å‡ç”³è¯·</div>
                <el-table :data="requestList" border stripe style="width: 100%">
                    <el-table-column prop="staff_name" label="ç”³è¯·äºº" width="120" align="center"></el-table-column>
                    <el-table-column prop="request_date" label="æ—¥æœŸ" width="150" align="center"></el-table-column>
                    <el-table-column label="ç”³è¯·ç­æ¬¡" width="120" align="center">
                        <template #default="scope"><b class="txt-p">{{ scope.row.shift_name }}</b></template>
                    </el-table-column>
                    <el-table-column prop="reason" label="å¤‡æ³¨äº‹ç”±"></el-table-column>
                    <el-table-column label="æ“ä½œ" width="150" align="center">
                        <template #default="scope">
                            <el-button type="danger" size="small" icon="Delete"
                                @click="deleteRequest(scope.row.id)">åˆ é™¤</el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <el-empty v-if="requestList.length === 0" description="æš‚æ— å¾…å¤„ç†çš„éœ€æ±‚ç”³è¯·"></el-empty>
            </el-tab-pane>

            <el-tab-pane name="staff">
                <template #label><el-icon>
                        <UserFilled />
                    </el-icon> äººå‘˜ç®¡ç†</template>
                <div class="action-bar">
                    <el-button type="primary" icon="Plus" @click="addDialogVisible = true">æ–°å¢ç§‘å®¤äººå‘˜</el-button>
                </div>
                <el-table :data="staffList" border stripe>
                    <el-table-column prop="id" label="å·¥å·" width="100" align="center"></el-table-column>
                    <el-table-column prop="name" label="å§“å" align="center"></el-table-column>
                    <el-table-column label="å‚ä¸å¤œç­å¾ªç¯" align="center" width="180">
                        <template #default="scope">
                            <el-switch v-model="scope.row.is_night_group" :active-value="1" :inactive-value="0"
                                @change="toggleNightStatus(scope.row)"></el-switch>
                        </template>
                    </el-table-column>
                    <el-table-column label="æ“ä½œ" align="center" width="150">
                        <template #default="scope">
                            <el-button type="danger" icon="Delete" @click="deleteStaff(scope.row.id)"
                                plain>ç§»é™¤äººå‘˜</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-tab-pane>

            <el-tab-pane name="history">
                <template #label><el-icon>
                        <Clock />
                    </el-icon> å†å²è¡¥å½•</template>
                <div class="action-bar">
                    <span>é€‰æ‹©èµ·å§‹å‘¨ä¸€ï¼š</span>
                    <el-date-picker v-model="historyMonday" type="date" value-format="YYYY-MM-DD"
                        :disabled-date="d => d.getDay() !== 1"></el-date-picker>
                    <el-button type="primary" icon="Search" @click="loadHistory">æŸ¥è¯¢</el-button>
                    <el-button type="success" icon="UploadFilled" @click="saveHistory">ä¿å­˜è¡¥å½•</el-button>
                </div>
                <el-table v-if="historyDays.length" :data="staffList" border size="small">
                    <el-table-column prop="name" label="å§“å" width="100" fixed align="center"></el-table-column>
                    <el-table-column v-for="day in historyDays" :key="day.date" :label="day.label" align="center">
                        <template #default="scope"><el-input v-model="historyModel[scope.row.id][day.date]"
                                size="small"></el-input></template>
                    </el-table-column>
                </el-table>
            </el-tab-pane>
        </el-tabs>

        <el-dialog v-model="addDialogVisible" title="å½•å…¥æ–°æŠ¤å£«" width="350px">
            <el-form :model="newStaff" label-width="80px">
                <el-form-item label="å§“å"><el-input v-model="newStaff.name"></el-input></el-form-item>
                <el-form-item label="å¤œç­ç»„"><el-switch v-model="newStaff.is_night_group" :active-value="1"
                        :inactive-value="0"></el-switch></el-form-item>
            </el-form>
            <template #footer><el-button @click="addDialogVisible = false">å–æ¶ˆ</el-button><el-button type="primary"
                    @click="submitAddStaff">ç¡®å®š</el-button></template>
        </el-dialog>

        <el-dialog v-model="requestShow" :title="'æäº¤ä¸ªäººéœ€æ±‚ - ' + currentStaff.name" width="400px">
            <el-form :model="formReq" label-width="80px">
                <el-form-item label="æ—¥æœŸ"><el-date-picker v-model="formReq.request_date" type="date"
                        value-format="YYYY-MM-DD" style="width:100%"></el-date-picker></el-form-item>
                <el-form-item label="æœŸæœ›ç­æ¬¡"><el-input v-model="formReq.shift_name"
                        placeholder="ä¾‹å¦‚ï¼šä¼‘"></el-input></el-form-item>
                <el-form-item label="å¤‡æ³¨äº‹ç”±"><el-input v-model="formReq.reason" type="textarea"
                        rows="3"></el-input></el-form-item>
            </el-form>
            <template #footer><el-button @click="requestShow = false">å–æ¶ˆ</el-button><el-button type="primary"
                    @click="submitRequest">æäº¤éœ€æ±‚</el-button></template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, onMounted, reactive } = Vue;
        const app = createApp({
            setup() {
                const activeTab = ref('schedule');
                const staffList = ref([]);
                const thisWeekData = ref({});
                const nextWeekData = ref({});
                const thisWeekDays = ref([]);
                const nextWeekDays = ref([]);
                const requestList = ref([]);
                const nextWeekRange = reactive({ start: '2026-01-12' });
                const shiftOptions = ['P', 'N', 'ä¼‘', 'ä¼‘(Prn)', 'A1', 'A2', 'åŠ©å¤œ', 'æ­£1', 'æ­£2', 'åŒ»å˜±', 'æœè¯', 'æ­£(ä¸­)', 'åŒ»+æœ'];

                const historyMonday = ref('');
                const historyDays = ref([]);
                const historyModel = ref({});

                const requestShow = ref(false);
                const currentStaff = ref({});
                const formReq = ref({ request_date: '', shift_name: 'ä¼‘', reason: '' });
                const addDialogVisible = ref(false);
                const newStaff = ref({ name: '', is_night_group: 0 });

                const loadAllData = async () => {
                    const res = await axios.get('/schedule/schedule/init');
                    const d = res.data.data;
                    staffList.value = d.staffs;
                    thisWeekData.value = d.thisWeek;
                    thisWeekDays.value = d.days;
                    nextWeekDays.value = d.nextDays;
                    requestList.value = d.requests || [];
                    const model = {};
                    d.staffs.forEach(s => {
                        model[s.id] = d.nextWeek[s.id] || {};
                        d.nextDays.forEach(day => { if (!model[s.id][day.date]) model[s.id][day.date] = ''; });
                    });
                    nextWeekData.value = model;
                };

                const getShiftTextClass = (s) => {
                    if (s === 'P') return 'txt-p';
                    if (s === 'N') return 'txt-n';
                    if (s?.includes('ä¼‘')) return 'txt-off';
                    return 'txt-work';
                };

                const tableRowClassName = ({ row }) => row.is_night_group === 1 ? 'night-row' : '';

                const copyLastWeek = () => {
                    staffList.value.forEach(s => {
                        thisWeekDays.value.forEach((day, index) => {
                            nextWeekData.value[s.id][nextWeekDays.value[index].date] = thisWeekData.value[s.id][day.date];
                        });
                    });
                    ElementPlus.ElMessage.success('å·²æ‹·è´æœ¬å‘¨æ•°æ®');
                };

                const handleGenerate = async () => {
                    const res = await axios.post('/schedule/schedule/generate', { start_date: nextWeekRange.start });
                    res.data.data.forEach(item => {
                        if (nextWeekData.value[item.staff_id]) nextWeekData.value[item.staff_id][item.work_date] = item.shift_name;
                    });
                };

                const validateAndSave = async () => {
                    try {
                        await axios.post('/schedule/schedule/save', { schedules: nextWeekData.value });
                        ElementPlus.ElMessage.success('ä¿å­˜æˆåŠŸ');
                        loadAllData();
                    } catch (err) {
                        const msg = err.response?.data?.errors?.join('<br>') || "ç³»ç»Ÿé”™è¯¯";
                        ElementPlus.ElMessageBox.alert(msg, 'ä¿å­˜å¤±è´¥', { dangerouslyUseHTMLString: true, type: 'error' });
                    }
                };

                const loadHistory = async () => {
                    const res = await axios.get(`/schedule/schedule/getWeek?start=${historyMonday.value}`);
                    const data = res.data.data;
                    historyDays.value = [];
                    const model = {};
                    for (let i = 0; i < 7; i++) {
                        let d = new Date(historyMonday.value); d.setDate(d.getDate() + i);
                        const ds = d.toISOString().split('T')[0];
                        historyDays.value.push({ label: `å‘¨${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][d.getDay()]}`, date: ds });
                    }
                    staffList.value.forEach(s => {
                        model[s.id] = {};
                        historyDays.value.forEach(d => { model[s.id][d.date] = data[s.id]?.[d.date] || ''; });
                    });
                    historyModel.value = model;
                };

                const saveHistory = async () => {
                    await axios.post('/schedule/schedule/save', { schedules: historyModel.value });
                    ElementPlus.ElMessage.success('å†å²è¡¥å½•å·²ä¿å­˜');
                };

                // éœ€æ±‚æ“ä½œ
                const openRequest = (row) => { currentStaff.value = row; requestShow.value = true; };
                const submitRequest = async () => {
                    // å…³é”®ä¿®æ­£ï¼šåç«¯å‚æ•°æ˜¯ 'shift'ï¼Œå‰ç«¯ä¹‹å‰ä¼ çš„æ˜¯ 'shift_name'
                    await axios.post('/schedule/schedule/addRequest', {
                        staff_id: currentStaff.value.id,
                        request_date: formReq.value.request_date,
                        shift: formReq.value.shift_name, // ä¿®æ­£ï¼šæ”¹ä¸º shift
                        reason: formReq.value.reason     // ç¡®ä¿å­—æ®µå­˜åœ¨
                    });
                    requestShow.value = false;
                    loadAllData();
                    ElementPlus.ElMessage.success('ç”³è¯·æäº¤æˆåŠŸ');
                };
                const deleteRequest = async (id) => {
                    await ElementPlus.ElMessageBox.confirm('ç¡®å®šåˆ é™¤è¯¥ç”³è¯·å—ï¼Ÿ');
                    await axios.post(`/schedule/schedule/deleteRequest/${id}`); // éœ€åç«¯æä¾›è¯¥æ¥å£
                    loadAllData();
                };

                // äººå‘˜æ“ä½œ
                const toggleNightStatus = async (row) => {
                    await axios.post('/schedule/staff/toggleNightGroup', { id: row.id, status: row.is_night_group });
                };
                const submitAddStaff = async () => {
                    await axios.post('/schedule/staff/add', newStaff.value);
                    addDialogVisible.value = false; loadAllData();
                };
                const deleteStaff = async (id) => {
                    await ElementPlus.ElMessageBox.confirm('ç¡®å®šä»ç³»ç»Ÿä¸­ç§»é™¤è¯¥äººå‘˜å—ï¼Ÿ');
                    await axios.post(`/schedule/staff/delete/${id}`);
                    loadAllData();
                };

                onMounted(loadAllData);
                return { activeTab, staffList, thisWeekData, nextWeekData, thisWeekDays, nextWeekDays, shiftOptions, getShiftTextClass, tableRowClassName, copyLastWeek, handleGenerate, validateAndSave, historyMonday, historyDays, historyModel, loadHistory, saveHistory, nextWeekRange, requestShow, currentStaff, formReq, openRequest, submitRequest, addDialogVisible, newStaff, submitAddStaff, deleteStaff, toggleNightStatus, requestList, deleteRequest };
            }
        });

        for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component); }
        app.use(ElementPlus).mount('#app');
    </script>
</body>

</html>